on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  id-token: write # Required for npm provenance

name: Release Please

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      # Capture the PR object and release status
      release_created: ${{ steps.release.outputs.release_created }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4

        with:
          release-type: node

  publish-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: npm ci

      - name: Build and Publish
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.NODE_AUTH_TOKEN}}

  publish-prerelease:
    needs: release-please
    if: ${{ needs.release-please.outputs.pr != '' && needs.release-please.outputs.release_created != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: npm ci

      - name: Calculate prerelease Version
        id: semver
        run: |
          # Extract the version from the PR title (e.g., "chore(main): release 1.8.0" -> "1.8.0")
          PR_TITLE=$(echo '${{ needs.release-please.outputs.pr }}' | jq -r '.title')
          TARGET_VERSION=$(echo "$PR_TITLE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

          if [ -z "$TARGET_VERSION" ]; then
            echo "Could not extract version from PR title: $PR_TITLE" >&2
            exit 1
          fi

          # Get the current @next version from npm
          CURRENT_NEXT=$(npm view @vis.gl/react-google-maps dist-tags.next 2>/dev/null || echo "")

          # If current @next is already an RC for this version, increment it; Otherwise, start at rc.1
          if [[ "$CURRENT_NEXT" == "$TARGET_VERSION-rc."* ]]; then
            NEXT_VERSION=$(npx -y semver $CURRENT_NEXT -i prerelease --preid rc)
          else
            
            NEXT_VERSION="${TARGET_VERSION}-rc.1"
          fi

          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Target version detected: $TARGET_VERSION"
          echo "Next RC version: $NEXT_VERSION"

      - name: Build and Publish to @next
        run: |
          # Overwrite package.json version locally for publish
          npm version ${{ steps.semver.outputs.version }} --no-git-tag-version
          npm publish --tag next --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = JSON.parse('${{ needs.release-please.outputs.pr }}').number;
            const version = '${{ steps.semver.outputs.version }}';
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸš€ **Pre-release published!**\n\nInstall this version for testing:\n\`\`\`bash\nnpm install @vis.gl/react-google-maps@${version}\n\`\`\`\nOr use the tag:\n\`\`\`bash\nnpm install @vis.gl/react-google-maps@next\n\`\`\``
            })
